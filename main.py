import yfinance as yf
import requests
import os

# 1. å–å¾— GitHub Secrets ç¶²å€
WEBHOOK = os.environ.get('DISCORD_WEBHOOK')

# 2. å®šç¾© 150 æª”åˆ†æžæ¸…å–® (åŒ…å«ä¸­æ–‡åç¨±)
STOCK_POOL = {
    "åŠå°Žé«”èˆ‡ AI æ ¸å¿ƒ": {
        "2330.TW": "å°ç©é›»", "2454.TW": "è¯ç™¼ç§‘", "2317.TW": "é´»æµ·", "2308.TW": "å°é”é›»", "2382.TW": "å»£é”",
        "3711.TW": "æ—¥æœˆå…‰æŠ•æŽ§", "3231.TW": "ç·¯å‰µ", "2357.TW": "è¯ç¢©", "6669.TW": "ç·¯ç©Ž", "2301.TW": "å…‰å¯¶ç§‘",
        "2379.TW": "ç‘žæ˜±", "3034.TW": "è¯è© ", "3037.TW": "æ¬£èˆˆ", "2408.TW": "å—äºžç§‘", "2303.TW": "è¯é›»",
        "4966.TW": "è­œç‘ž-KY", "3661.TW": "ä¸–èŠ¯-KY", "5269.TW": "ç¥¥ç¢©", "3443.TW": "å‰µæ„", "3035.TW": "æ™ºåŽŸ",
        "8046.TW": "å—é›»", "2360.TW": "è‡´èŒ‚", "3532.TW": "å°å‹ç§‘", "6239.TW": "åŠ›æˆ", "2449.TW": "äº¬å…ƒé›»å­",
        "3017.TW": "å¥‡é‹", "3321.TW": "åŒæ³°", "6213.TW": "è¯èŒ‚", "2383.TW": "å°å…‰é›»", "3023.TW": "ä¿¡é‚¦",
        "3653.TW": "å¥ç­–", "6176.TW": "ç‘žå„€", "4958.TW": "è‡»é¼Ž-KY", "2474.TW": "å¯æˆ", "3131.TW": "å¼˜å¡‘",
        "3583.TW": "è¾›è€˜", "1560.TW": "å‹¤èª ", "2376.TW": "æŠ€å˜‰", "2353.TW": "å®ç¢", "2324.TW": "ä»å¯¶"
    },
    "é—œéµé›¶çµ„ä»¶": {
        "2327.TW": "åœ‹å·¨", "2492.TW": "è¯æ–°ç§‘", "3044.TW": "å¥é¼Ž", "2313.TW": "è¯é€š", "2367.TW": "ç‡¿è¯",
        "2368.TW": "é‡‘åƒé›»", "3189.TW": "æ™¯ç¢©", "3006.TW": "æ™¶è±ªç§‘", "2451.TW": "å‰µè¦‹", "2352.TW": "ä½³ä¸–é”",
        "2355.TW": "æ•¬éµ¬", "2458.TW": "ç¾©éš†", "3533.TW": "å˜‰æ¾¤", "6206.TW": "é£›æ·", "3014.TW": "è¯é™½",
        "2439.TW": "ç¾Žå¾‹", "2480.TW": "æ•¦é™½ç§‘", "6116.TW": "å½©æ™¶", "8215.TW": "æ˜ŽåŸºæ", "2347.TW": "è¯å¼·",
        "2344.TW": "è¯é‚¦é›»", "5347.TW": "ä¸–ç•Œå…ˆé€²", "2455.TW": "å…¨æ–°", "2441.TW": "è¶…è±", "3293.TW": "éˆŠè±¡",
        "3592.TW": "ç‘žé¼Ž", "6706.TW": "å‹è±", "6719.TW": "åŠ›æ™º", "6770.TW": "åŠ›ç©é›»", "8069.TW": "å…ƒå¤ª"
    },
    "ç¶ èƒ½å‚³ç”¢": {
        "1513.TW": "ä¸­èˆˆé›»", "1519.TW": "è¯åŸŽ", "1503.TW": "å£«é›»", "1504.TW": "æ±å…ƒ", "1605.TW": "è¯æ–°",
        "1514.TW": "äºžåŠ›", "1101.TW": "å°æ³¥", "1102.TW": "äºžæ³¥", "1301.TW": "å°å¡‘", "1303.TW": "å—äºž",
        "1326.TW": "å°åŒ–", "6505.TW": "å°å¡‘åŒ–", "1717.TW": "é•·èˆˆ", "1722.TW": "å°è‚¥", "2105.TW": "æ­£æ–°",
        "2103.TW": "å°æ©¡", "2002.TW": "ä¸­é‹¼", "2006.TW": "æ±å’Œ", "2014.TW": "ä¸­é´»", "1216.TW": "çµ±ä¸€",
        "1210.TW": "å¤§æˆ", "9910.TW": "è±æ³°", "9921.TW": "å·¨å¤§", "9914.TW": "ç¾Žåˆ©é”", "1476.TW": "å„’é´»",
        "1477.TW": "èšé™½", "2603.TW": "é•·æ¦®", "2609.TW": "é™½æ˜Ž", "2615.TW": "è¬æµ·", "2618.TW": "é•·æ¦®èˆª",
        "2610.TW": "è¯èˆª", "2707.TW": "æ™¶è¯", "2723.TW": "ç¾Žé£Ÿ", "2912.TW": "çµ±ä¸€è¶…", "5904.TW": "å¯¶é›…",
        "8454.TW": "å¯Œé‚¦åª’", "9945.TW": "æ½¤æ³°æ–°", "2542.TW": "èˆˆå¯Œç™¼", "5522.TW": "é é›„", "1802.TW": "å°çŽ»"
    },
    "é‡‘èžæ¬Šå€¼": {
        "2881.TW": "å¯Œé‚¦é‡‘", "2882.TW": "åœ‹æ³°é‡‘", "2886.TW": "å…†è±é‡‘", "2891.TW": "ä¸­ä¿¡é‡‘", "2884.TW": "çŽ‰å±±é‡‘",
        "2880.TW": "è¯å—é‡‘", "2885.TW": "å…ƒå¤§é‡‘", "2892.TW": "ç¬¬ä¸€é‡‘", "5880.TW": "åˆåº«é‡‘", "2883.TW": "é–‹ç™¼é‡‘",
        "2887.TW": "å°æ–°é‡‘", "2890.TW": "æ°¸è±é‡‘", "5871.TW": "ä¸­ç§Ÿ-KY", "5876.TW": "ä¸Šæµ·å•†éŠ€", "2801.TW": "å½°éŠ€",
        "2812.TW": "å°ä¸­éŠ€", "2834.TW": "è‡ºä¼éŠ€", "2888.TW": "æ–°å…‰é‡‘", "2845.TW": "é æ±éŠ€", "2851.TW": "ä¸­å†ä¿"
    }
}

# 3. å®¢æˆ¶æŒå€‰æ¸…å–® (è‹¥æœ‰ç•°å‹•åœ¨æ­¤ä¿®æ”¹)
MY_PORTFOLIO = {"3023.TW": 280.5, "2330.TW": 950.0}

def analyze():
    final_report = "ðŸ“Š **150æª”å…¨å¸‚å ´æŽƒæå ±å‘Š**\n"
    
    for category, stocks in STOCK_POOL.items():
        final_report += f"\nã€{category}ã€‘\n"
        for sym, name in stocks.items():
            try:
                # æŠ“å–ä¸€å€‹æœˆçš„æ•¸æ“šä¾†ç®—å‡ç·š
                ticker = yf.Ticker(sym)
                df = ticker.history(period="1mo")
                if df.empty: continue
                
                curr_p = df['Close'].iloc[-1]
                ma20 = df['Close'].rolling(window=20).mean().iloc[-1]
                
                # åˆ†æžï¼šç¾åƒ¹é«˜æ–¼å‡ç·šç‚ºå¤šé ­(ðŸ”¥)ï¼Œä½Žæ–¼ç‚ºç©ºé ­(â„ï¸)
                trend = "ðŸ”¥" if curr_p > ma20 else "â„ï¸"
                final_report += f"{trend} {name}({sym}): {round(curr_p,1)}\n"
            except:
                final_report += f"âš ï¸ {name}({sym}): è®€å–å¤±æ•—\n"

    # 4. æ’å…¥æŒå€‰æç›Šå ±å‘Š
    p_report = "\nðŸ›ï¸ **å®¢æˆ¶æŒå€‰æç›Šç¸½çµ**\n"
    for sym, buy_p in MY_PORTFOLIO.items():
        ticker = yf.Ticker(sym)
        df = ticker.history(period="1d")
        if not df.empty:
            curr_p = df['Close'].iloc[-1]
            diff = (curr_p - buy_p) / buy_p * 100
            p_report += f"â— {sym}: æˆæœ¬ {buy_p} â†’ ç¾åƒ¹ {round(curr_p,1)} ({round(diff,2)}%)\n"

    # 5. ç™¼é€
    full_msg = p_report + "\n" + final_report
    # è‹¥è¨Šæ¯å¤ªé•·ï¼Œåˆ†å…©æ®µç™¼é€
    if len(full_msg) > 2000:
        requests.post(WEBHOOK, json={"content": p_report})
        requests.post(WEBHOOK, json={"content": final_report[:2000]})
    else:
        requests.post(WEBHOOK, json={"content": full_msg})

if __name__ == "__main__":
    analyze()
