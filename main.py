import yfinance as yf
import requests
import os
from datetime import datetime, timedelta

WEBHOOK = os.environ.get('DISCORD_WEBHOOK')

# 1. æŒå€‰æ¸…å–® (å·²æ”¹ç‚ºè‚¡æ•¸ shares)
MY_PORTFOLIO = {
    "3023.TW": {"name": "ä¿¡é‚¦", "cost": 280.5, "shares": 1000},
    "2330.TW": {"name": "å°ç©é›»", "cost": 950.0, "shares": 500} # èˆ‰ä¾‹ï¼šè²· 500 è‚¡
}

# 2. 150 æª”å…¨å¸‚å ´æƒææ¸…å–® (å®Œæ•´ä»£ç¢¼èˆ‡ä¸­æ–‡)
STOCK_POOL = {
    "åŠå°é«”èˆ‡ AI æ ¸å¿ƒ": {
        "2330.TW": "å°ç©é›»", "2454.TW": "è¯ç™¼ç§‘", "2317.TW": "é´»æµ·", "2308.TW": "å°é”é›»", "2382.TW": "å»£é”",
        "3711.TW": "æ—¥æœˆå…‰æŠ•æ§", "3231.TW": "ç·¯å‰µ", "2357.TW": "è¯ç¢©", "6669.TW": "ç·¯ç©", "2301.TW": "å…‰å¯¶ç§‘",
        "2379.TW": "ç‘æ˜±", "3034.TW": "è¯è© ", "3037.TW": "æ¬£èˆˆ", "2408.TW": "å—äºç§‘", "2303.TW": "è¯é›»",
        "4966.TW": "è­œç‘-KY", "3661.TW": "ä¸–èŠ¯-KY", "5269.TW": "ç¥¥ç¢©", "3443.TW": "å‰µæ„", "3035.TW": "æ™ºåŸ",
        "8046.TW": "å—é›»", "2360.TW": "è‡´èŒ‚", "3532.TW": "å°å‹ç§‘", "6239.TW": "åŠ›æˆ", "2449.TW": "äº¬å…ƒé›»å­",
        "3017.TW": "å¥‡é‹", "3321.TW": "åŒæ³°", "6213.TW": "è¯èŒ‚", "2383.TW": "å°å…‰é›»", "3023.TW": "ä¿¡é‚¦",
        "3653.TW": "å¥ç­–", "6176.TW": "ç‘å„€", "4958.TW": "è‡»é¼-KY", "2474.TW": "å¯æˆ", "3131.TW": "å¼˜å¡‘",
        "3583.TW": "è¾›è€˜", "1560.TW": "å‹¤èª ", "2376.TW": "æŠ€å˜‰", "2353.TW": "å®ç¢", "2324.TW": "ä»å¯¶"
    },
    "é—œéµé›¶çµ„ä»¶èˆ‡å…‰é›»": {
        "2327.TW": "åœ‹å·¨", "2492.TW": "è¯æ–°ç§‘", "3044.TW": "å¥é¼", "2313.TW": "è¯é€š", "2367.TW": "ç‡¿è¯",
        "2368.TW": "é‡‘åƒé›»", "3189.TW": "æ™¯ç¢©", "3006.TW": "æ™¶è±ªç§‘", "2451.TW": "å‰µè¦‹", "2352.TW": "ä½³ä¸–é”",
        "2355.TW": "æ•¬éµ¬", "2458.TW": "ç¾©éš†", "3533.TW": "å˜‰æ¾¤", "6206.TW": "é£›æ·", "3014.TW": "è¯é™½",
        "2439.TW": "ç¾å¾‹", "2480.TW": "æ•¦é™½ç§‘", "6116.TW": "å½©æ™¶", "8215.TW": "æ˜åŸºæ", "2347.TW": "è¯å¼·",
        "2344.TW": "è¯é‚¦é›»", "5347.TW": "ä¸–ç•Œå…ˆé€²", "2455.TW": "å…¨æ–°", "2441.TW": "è¶…è±", "3293.TW": "éˆŠè±¡",
        "3592.TW": "ç‘é¼", "6706.TW": "å‹è±", "6719.TW": "åŠ›æ™º", "6770.TW": "åŠ›ç©é›»", "8069.TW": "å…ƒå¤ª",
        "3406.TW": "ç‰æ™¶å…‰", "3008.TW": "å¤§ç«‹å…‰", "3504.TW": "æšæ˜å…‰", "2409.TW": "å‹é”", "3481.TW": "ç¾¤å‰µ"
    },
    "é‡é›»ç¶ èƒ½èˆ‡èˆªé‹å‚³ç”¢": {
        "1513.TW": "ä¸­èˆˆé›»", "1519.TW": "è¯åŸ", "1503.TW": "å£«é›»", "1504.TW": "æ±å…ƒ", "1605.TW": "è¯æ–°",
        "1514.TW": "äºåŠ›", "1101.TW": "å°æ³¥", "1102.TW": "äºæ³¥", "1301.TW": "å°å¡‘", "1303.TW": "å—äº",
        "1326.TW": "å°åŒ–", "6505.TW": "å°å¡‘åŒ–", "1717.TW": "é•·èˆˆ", "1722.TW": "å°è‚¥", "2105.TW": "æ­£æ–°",
        "2103.TW": "å°æ©¡", "2002.TW": "ä¸­é‹¼", "2006.TW": "æ±å’Œé‹¼éµ", "2014.TW": "ä¸­é´»", "1216.TW": "çµ±ä¸€",
        "1210.TW": "å¤§æˆ", "9910.TW": "è±æ³°", "9921.TW": "å·¨å¤§", "9914.TW": "ç¾åˆ©é”", "1476.TW": "å„’é´»",
        "1477.TW": "èšé™½", "2603.TW": "é•·æ¦®", "2609.TW": "é™½æ˜", "2615.TW": "è¬æµ·", "2618.TW": "é•·æ¦®èˆª",
        "2610.TW": "è¯èˆª", "2707.TW": "æ™¶è¯", "2723.TW": "ç¾é£Ÿ-KY", "2912.TW": "çµ±ä¸€è¶…", "5904.TW": "å¯¶é›…",
        "8454.TW": "å¯Œé‚¦åª’", "9945.TW": "æ½¤æ³°æ–°", "2542.TW": "èˆˆå¯Œç™¼", "5522.TW": "é é›„", "1802.TW": "å°ç»"
    },
    "é‡‘èæ¬Šå€¼": {
        "2881.TW": "å¯Œé‚¦é‡‘", "2882.TW": "åœ‹æ³°é‡‘", "2886.TW": "å…†è±é‡‘", "2891.TW": "ä¸­ä¿¡é‡‘", "2884.TW": "ç‰å±±é‡‘",
        "2880.TW": "è¯å—é‡‘", "2885.TW": "å…ƒå¤§é‡‘", "2892.TW": "ç¬¬ä¸€é‡‘", "5880.TW": "åˆåº«é‡‘", "2883.TW": "é–‹ç™¼é‡‘",
        "2887.TW": "å°æ–°é‡‘", "2890.TW": "æ°¸è±é‡‘", "5871.TW": "ä¸­ç§Ÿ-KY", "5876.TW": "ä¸Šæµ·å•†éŠ€", "2801.TW": "å½°éŠ€",
        "2812.TW": "å°ä¸­éŠ€", "2834.TW": "è‡ºä¼éŠ€", "2888.TW": "æ–°å…‰é‡‘", "2845.TW": "é æ±éŠ€", "2851.TW": "ä¸­å†ä¿"
    }
}

def get_report_title():
    h = (datetime.now() + timedelta(hours=8)).hour
    if h == 6: return "ğŸŒ… ç¾è‚¡æ”¶ç›¤ç¸½çµ & å°è‚¡é åˆ¤"
    if h == 8: return "â˜• å°è‚¡ç›¤å‰ç­–ç•¥æé†’"
    if h == 10: return "ğŸ“Š å°è‚¡ç›¤ä¸­èµ°å‹¢è§€å¯Ÿ"
    if h == 13: return "ğŸ å°è‚¡æ”¶ç›¤æç›Šçµç®—"
    return "ğŸ”” ç³»çµ±å³æ™‚å›å ±"

def get_us_expert_analysis():
    indices = {"^SOX": "è²»åŠæŒ‡æ•¸", "NVDA": "è¼é”", "^IXIC": "é‚£æ–¯é”å…‹"}
    report = "ğŸ›ï¸ **ç¾è‚¡å°ˆæ¥­æŠ€è¡“åˆ†æèˆ‡é åˆ¤**\n------------------\n"
    sox_chg = 0
    for sym, name in indices.items():
        d = yf.Ticker(sym).history(period="2d")
        chg = ((d['Close'].iloc[-1] / d['Close'].iloc[-2]) - 1) * 100
        if sym == "^SOX": sox_chg = chg
        report += f"â— {name}: {round(chg,2)}%\n"
    
    report += "\nğŸ” **æŠ€è¡“é¢é åˆ¤ï¼š**\n"
    if sox_chg > 1.5:
        report += "ã€å¼·å‹¢ã€‘æ­·å²é¡¯ç¤ºè²»åŠé ˜æ¼²å°‡å¸¶å‹•å°è‚¡AIèˆ‡åŠå°é«”æ—ç¾¤å™´å‡ºï¼Œé€±ä¸€é–‹ç›¤çœ‹å¥½å°ç©é›»ã€å»£é”ã€‚\n"
    elif sox_chg < -1.5:
        report += "ã€å¼±å‹¢ã€‘è²»åŠé‡æŒ«æå¼•ç™¼å°è‚¡é›»å­è‚¡è£œè·Œï¼Œå»ºè­°é—œæ³¨é‡‘èè‚¡é¿éšªä½éšã€‚\n"
    else:
        report += "ã€éœ‡ç›ªã€‘å¸‚å ´è§€æœ›æƒ…ç·’æ¿ƒï¼Œé è¨ˆç›¤å‹¢ç”±å€‹åˆ¥æ¨™çš„ç±Œç¢¼æ±ºå®šã€‚\n"
    return report

def run():
    title = get_report_title()
    now_str = (datetime.now() + timedelta(hours=8)).strftime('%Y-%m-%d %H:%M')
    
    # 1. ä¸­æ–‡æç›Šè¡¨ (ä»¥è‚¡æ•¸ shares è¨ˆç®—)
    p_report = f"ã€{title}ã€‘\næ™‚é–“ï¼š{now_str}\n\nğŸ›ï¸ **å®¢æˆ¶æŒå€‰æç›Š (TWD)**\n"
    total_profit = 0
    for sym, info in MY_PORTFOLIO.items():
        t = yf.Ticker(sym)
        df = t.history(period="5d")
        if not df.empty:
            curr = df['Close'].iloc[-1]
            diff_cash = (curr - info["cost"]) * info["shares"] # è‚¡æ•¸è¨ˆç®—
            total_profit += diff_cash
            p_report += f"â— {info['name']}({sym}): NT$ {int(diff_cash):,} ({round((curr-info['cost'])/info['cost']*100,2)}%)\n"
    p_report += f"ğŸ’° **ç¸½ç´¯ç©æç›Šï¼šNT$ {int(total_profit):,}**\n\n"

    # 2. ç¾è‚¡åˆ†æ
    us_report = get_us_expert_analysis()

    # 3. 150 æª”åˆ†æ
    stock_report = "\nğŸ¯ **150 æª”å€‹è‚¡å¤šé ­å‹•èƒ½ç›£æ§**\n"
    for cat, stocks in STOCK_POOL.items():
        cat_txt = f"ã€{cat}ã€‘: "
        found = False
        for sym, name in stocks.items():
            try:
                df = yf.Ticker(sym).history(period="20d")
                if df['Close'].iloc[-1] > df['Close'].mean(): # ç«™ä¸Šå‡ç·š
                    cat_txt += f"{name} "
                    found = True
            except: continue
        if found: stock_report += cat_txt + "\n"

    full_text = p_report + us_report + stock_report
    for i in range(0, len(full_text), 1900):
        requests.post(WEBHOOK, json={"content": full_text[i:i+1900]})

if __name__ == "__main__":
    run()
