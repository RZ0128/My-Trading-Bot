import yfinance as yf
import requests
import os

# 1. è¨­å®šå€ï¼šä¿éšªç®±ç¶²å€èˆ‡ç¯©é¸é–€æª»
WEBHOOK = os.environ.get('DISCORD_WEBHOOK')
MIN_GAIN = 10.0  # é æœŸæ¼²å¹…ä½æ–¼ 10% å‰‡ä¸é¡¯ç¤ºåœ¨æ¨è–¦æ¸…å–®ä¸­

# 2. å®¢æˆ¶æŒå€‰æ¸…å–® (å·²ä¿®æ­£ç‚ºå­—å…¸æ ¼å¼ï¼Œä¸¦æ”¯æ´ä¸­æ–‡é¡¯ç¤º)
MY_PORTFOLIO = {
    "3023.TW": {"name": "ä¿¡é‚¦", "cost": 280.5},
    "2330.TW": {"name": "å°ç©é›»", "cost": 950.0}
}

# 3. 150 æª”å…¨å¸‚å ´æƒææ¸…å–®
STOCK_POOL = {
    "åŠå°é«”èˆ‡ AI æ ¸å¿ƒ": {
        "2330.TW": "å°ç©é›»", "2454.TW": "è¯ç™¼ç§‘", "2317.TW": "é´»æµ·", "2308.TW": "å°é”é›»", "2382.TW": "å»£é”",
        "3711.TW": "æ—¥æœˆå…‰æŠ•æ§", "3231.TW": "ç·¯å‰µ", "2357.TW": "è¯ç¢©", "6669.TW": "ç·¯ç©", "2301.TW": "å…‰å¯¶ç§‘",
        "2379.TW": "ç‘æ˜±", "3034.TW": "è¯è© ", "3037.TW": "æ¬£èˆˆ", "2408.TW": "å—äºç§‘", "2303.TW": "è¯é›»",
        "4966.TW": "è­œç‘-KY", "3661.TW": "ä¸–èŠ¯-KY", "5269.TW": "ç¥¥ç¢©", "3443.TW": "å‰µæ„", "3035.TW": "æ™ºåŸ",
        "8046.TW": "å—é›»", "2360.TW": "è‡´èŒ‚", "3532.TW": "å°å‹ç§‘", "6239.TW": "åŠ›æˆ", "2449.TW": "äº¬å…ƒé›»å­",
        "3017.TW": "å¥‡é‹", "3321.TW": "åŒæ³°", "6213.TW": "è¯èŒ‚", "2383.TW": "å°å…‰é›»", "3023.TW": "ä¿¡é‚¦",
        "3653.TW": "å¥ç­–", "6176.TW": "ç‘å„€", "4958.TW": "è‡»é¼-KY", "2474.TW": "å¯æˆ", "3131.TW": "å¼˜å¡‘",
        "3583.TW": "è¾›è€˜", "1560.TW": "å‹¤èª ", "2376.TW": "æŠ€å˜‰", "2353.TW": "å®ç¢", "2324.TW": "ä»å¯¶"
    },
    "é—œéµé›¶çµ„ä»¶": {
        "2327.TW": "åœ‹å·¨", "2492.TW": "è¯æ–°ç§‘", "3044.TW": "å¥é¼", "2313.TW": "è¯é€š", "2367.TW": "ç‡¿è¯",
        "2368.TW": "é‡‘åƒé›»", "3189.TW": "æ™¯ç¢©", "3006.TW": "æ™¶è±ªç§‘", "2451.TW": "å‰µè¦‹", "2352.TW": "ä½³ä¸–é”",
        "2355.TW": "æ•¬éµ¬", "2458.TW": "ç¾©éš†", "3533.TW": "å˜‰æ¾¤", "6206.TW": "é£›æ·", "3014.TW": "è¯é™½",
        "2439.TW": "ç¾å¾‹", "2480.TW": "æ•¦é™½ç§‘", "6116.TW": "å½©æ™¶", "8215.TW": "æ˜åŸºæ", "2347.TW": "è¯å¼·",
        "2344.TW": "è¯é‚¦é›»", "5347.TW": "ä¸–ç•Œå…ˆé€²", "2455.TW": "å…¨æ–°", "2441.TW": "è¶…è±", "3293.TW": "éˆŠè±¡",
        "3592.TW": "ç‘é¼", "6706.TW": "å‹è±", "6719.TW": "åŠ›æ™º", "6770.TW": "åŠ›ç©é›»", "8069.TW": "å…ƒå¤ª"
    },
    "é‡é›»ç¶ èƒ½å‚³ç”¢": {
        "1513.TW": "ä¸­èˆˆé›»", "1519.TW": "è¯åŸ", "1503.TW": "å£«é›»", "1504.TW": "æ±å…ƒ", "1605.TW": "è¯æ–°",
        "1514.TW": "äºåŠ›", "1101.TW": "å°æ³¥", "1102.TW": "äºæ³¥", "1301.TW": "å°å¡‘", "1303.TW": "å—äº",
        "1326.TW": "å°åŒ–", "6505.TW": "å°å¡‘åŒ–", "1717.TW": "é•·èˆˆ", "1722.TW": "å°è‚¥", "2105.TW": "æ­£æ–°",
        "2103.TW": "å°æ©¡", "2002.TW": "ä¸­é‹¼", "2006.TW": "æ±å’Œé‹¼éµ", "2014.TW": "ä¸­é´»", "1216.TW": "çµ±ä¸€",
        "1210.TW": "å¤§æˆ", "9910.TW": "è±æ³°", "9921.TW": "å·¨å¤§", "9914.TW": "ç¾åˆ©é”", "1476.TW": "å„’é´»",
        "1477.TW": "èšé™½", "2603.TW": "é•·æ¦®", "2609.TW": "é™½æ˜", "2615.TW": "è¬æµ·", "2618.TW": "é•·æ¦®èˆª",
        "2610.TW": "è¯èˆª", "2707.TW": "æ™¶è¯", "2723.TW": "ç¾é£Ÿ-KY", "2912.TW": "çµ±ä¸€è¶…", "5904.TW": "å¯¶é›…",
        "8454.TW": "å¯Œé‚¦åª’", "9945.TW": "æ½¤æ³°æ–°", "2542.TW": "èˆˆå¯Œç™¼", "5522.TW": "é é›„", "1802.TW": "å°ç»"
    },
    "é‡‘èæ¬Šå€¼": {
        "2881.TW": "å¯Œé‚¦é‡‘", "2882.TW": "åœ‹æ³°é‡‘", "2886.TW": "å…†è±é‡‘", "2891.TW": "ä¸­ä¿¡é‡‘", "2884.TW": "ç‰å±±é‡‘",
        "2880.TW": "è¯å—é‡‘", "2885.TW": "å…ƒå¤§é‡‘", "2892.TW": "ç¬¬ä¸€é‡‘", "5880.TW": "åˆåº«é‡‘", "2883.TW": "é–‹ç™¼é‡‘",
        "2887.TW": "å°æ–°é‡‘", "2890.TW": "æ°¸è±é‡‘", "5871.TW": "ä¸­ç§Ÿ-KY", "5876.TW": "ä¸Šæµ·å•†éŠ€", "2801.TW": "å½°éŠ€",
        "2812.TW": "å°ä¸­éŠ€", "2834.TW": "è‡ºä¼éŠ€", "2888.TW": "æ–°å…‰é‡‘", "2845.TW": "é æ±éŠ€", "2851.TW": "ä¸­å†ä¿"
    }
}

def get_analysis(df):
    """è¨ˆç®—æŠ€è¡“é¢æ·±åº¦åˆ†æé‚è¼¯"""
    close = df['Close'].iloc[-1]
    ma20 = df['Close'].rolling(window=20).mean().iloc[-1]
    ma5 = df['Close'].rolling(window=5).mean().iloc[-1]
    exp12 = df['Close'].ewm(span=12, adjust=False).mean()
    exp26 = df['Close'].ewm(span=26, adjust=False).mean()
    macd = exp12 - exp26
    sig = macd.ewm(span=9, adjust=False).mean()
    
    # é æœŸæ¼²å¹…è¨ˆç®—
    expected = round(df['Close'].pct_change().std() * 250, 1)
    
    reason = "æ—¥Kç«™ç©©æœˆç·šï¼Œ"
    if ma5 > ma20: reason += "5æ—¥ç·šå™´å‡ºå¼·å‹¢ï¼›"
    if macd.iloc[-1] > sig.iloc[-1]: reason += "MACDä½æª”ç¿»æšé‡‘å‰ï¼›"
    reason += "é€±Kè¶¨å‹¢åå¤šã€‚"
    
    proof = "æ­·å²å›æ¸¬é¡¯ç¤ºæ­¤ä½éšå•Ÿå‹•å¾ŒçºŒèˆªåŠ›å¼·ã€‚"
    if close > df['Close'].max() * 0.95: proof = "é«˜æª”çªç ´æ…£æ€§ï¼Œæ­·å²è¿½åƒ¹å‹ç‡é«˜ã€‚"
    
    return expected, reason, proof

def run():
    p_report = "ğŸ›ï¸ **å®¢æˆ¶æŒå€‰æç›Šå ±å‘Š**\n"
    # ä¿®æ­£é‡é»ï¼šæ­£ç¢ºè®€å– MY_PORTFOLIO å­—å…¸ä¸­çš„åç¨±èˆ‡æˆæœ¬
    for sym, info in MY_PORTFOLIO.items():
        name = info["name"]
        buy_p = info["cost"]
        ticker = yf.Ticker(sym)
        df = ticker.history(period="1mo")
        if not df.empty:
            curr = df['Close'].iloc[-1]
            diff = (curr - buy_p) / buy_p * 100
            p_report += f"â— {name}({sym}): æˆæœ¬ {buy_p} â†’ ç¾åƒ¹ {round(curr,1)} ({round(diff,2)}%)\n"

    final_report = f"ğŸ¯ **é«˜å‹ç‡ç²¾é¸ (é æœŸæ¼²å¹… > {MIN_GAIN}%)**\n"
    count = 0
    for cat, stocks in STOCK_POOL.items():
        cat_section = f"\nã€{cat}ã€‘\n"
        has_bull = False
        for sym, name in stocks.items():
            try:
                df = yf.Ticker(sym).history(period="3mo")
                if len(df) < 20: continue
                curr = df['Close'].iloc[-1]
                ma20 = df['Close'].rolling(window=20).mean().iloc[-1]
                if curr > ma20:
                    gain, reason, proof = get_analysis(df)
                    if gain >= MIN_GAIN:
                        has_bull = True
                        cat_section += f"ğŸš€ **{name}({sym})**: ç¾åƒ¹ {round(curr,1)}\n"
                        cat_section += f" â”” ğŸ“ˆ é æœŸæ¼²å¹…ï¼š+{gain}%\n"
                        cat_section += f" â”” ğŸ”¬ æŠ€è¡“é¢ï¼š{reason}\n"
                        cat_section += f" â”” ğŸ“œ æ­·å²ä½è­‰ï¼š{proof}\n\n"
                        count += 1
            except: continue
        if has_bull: final_report += cat_section

    if count == 0:
        final_report += f"\n(æœ¬æ—¥ç„¡é æœŸæ¼²å¹…å¤§æ–¼ {MIN_GAIN}% ä¹‹æ¨™çš„)"

    # ç™¼é€é‚è¼¯
    full_text = p_report + "\n" + final_report
    for i in range(0, len(full_text), 1900):
        requests.post(WEBHOOK, json={"content": full_text[i:i+1900]})

if __name__ == "__main__":
    run()

